<!--æ´»åŠ¨è¯¦æƒ…é¡µé¢-->
<view class="container">
  <!-- åŠ è½½ä¸­ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- é¡µé¢å†…å®¹ -->
  <block wx:elif="{{activity}}">
    <!-- åˆ›å»º/ç¼–è¾‘æ¨¡å¼ -->
    <block wx:if="{{type === 'create' || isEdit}}">
      <view class="form-card">
        <view class="form-title">{{ type === 'create' ? 'åˆ›å»ºæ´»åŠ¨' : 'ç¼–è¾‘æ´»åŠ¨' }}</view>
        
        <view class="form-group">
          <view class="form-label">æ´»åŠ¨åç§° <text class="required">*</text></view>
          <input class="form-control" placeholder="è¯·è¾“å…¥æ´»åŠ¨åç§°" value="{{activity.activityName}}" 
            bindinput="inputChange" data-field="activityName" disabled="{{readonly}}" />
        </view>
        
        <view class="form-group">
          <view class="form-label">æ´»åŠ¨æè¿°</view>
          <textarea class="form-textarea" placeholder="è¯·è¾“å…¥æ´»åŠ¨æè¿°" value="{{activity.activityDesc}}" 
            bindinput="inputChange" data-field="activityDesc" disabled="{{readonly}}"></textarea>
        </view>
        
        <view class="form-group">
          <view class="form-label">æ´»åŠ¨æ—¶é—´ <text class="required">*</text></view>
          <view class="time-picker" bindtap="chooseActivityTime">
            <text>{{activity.formattedTime || 'è¯·é€‰æ‹©æ—¶é—´'}}</text>
            <text class="icon-time" wx:if="{{!readonly}}">â±ï¸</text>
          </view>
        </view>
        
        <view class="form-group">
          <view class="form-label">æ´»åŠ¨åœ°ç‚¹ <text class="required">*</text></view>
          <view class="location-picker" bindtap="chooseLocation">
            <text>{{activity.activityLocation || 'è¯·é€‰æ‹©åœ°ç‚¹'}}</text>
            <text class="icon-location" wx:if="{{!readonly}}">ğŸ“</text>
          </view>
        </view>
        
        <view class="form-group">
          <view class="form-label">é¢„çº¦æ—¶é—´</view>
          <view class="time-range">
            <view class="time-picker" bindtap="chooseReserveTime" data-type="start">
              <text>{{activity.reserveTimeStart ? (activity.formattedReserveTime ? activity.formattedReserveTime.split(' - ')[0] : 'è¯·é€‰æ‹©æ—¶é—´') : 'è¯·é€‰æ‹©æ—¶é—´'}}</text>
              <text class="icon-time" wx:if="{{!readonly}}">â±ï¸</text>
            </view>
            <view class="time-separator">è‡³</view>
            <view class="time-picker" bindtap="chooseReserveTime" data-type="end">
              <text>{{activity.reserveTimeEnd ? (activity.formattedReserveTime ? activity.formattedReserveTime.split(' - ')[1] : 'è¯·é€‰æ‹©æ—¶é—´') : 'è¯·é€‰æ‹©æ—¶é—´'}}</text>
              <text class="icon-time" wx:if="{{!readonly}}">â±ï¸</text>
            </view>
          </view>
        </view>
        
        <view class="form-group">
          <view class="form-label">ç­¾åˆ°è¦æ±‚</view>
          <view class="checkbox-group">
            <view class="checkbox-item" bindtap="toggleNeedFace">
              <view class="checkbox {{activity.needFace ? 'checked' : ''}}"></view>
              <view class="checkbox-label">äººè„¸è¯†åˆ«</view>
            </view>
            <view class="checkbox-item" bindtap="toggleNeedPhoto">
              <view class="checkbox {{activity.needPhoto ? 'checked' : ''}}"></view>
              <view class="checkbox-label">ç…§ç‰‡ç­¾åˆ°</view>
            </view>
          </view>
        </view>
      </view>

      <view class="bottom-bar">
        <button class="btn-cancel" bindtap="cancelEdit" wx:if="{{!type}}">å–æ¶ˆ</button>
        <button class="btn-save" bindtap="saveActivity">{{ type === 'create' ? 'åˆ›å»ºæ´»åŠ¨' : 'ä¿å­˜ä¿®æ”¹' }}</button>
      </view>
    </block>

    <!-- æŸ¥çœ‹æ¨¡å¼ -->
    <block wx:else>
      <view class="activity-card">
        <view class="activity-title">{{activity.activityName}}</view>
        <view class="activity-desc">{{activity.activityDesc}}</view>
        
        <view class="info-section">
          <view class="info-item">
            <view class="info-icon">ğŸ•’</view>
            <view class="info-content">
              <view class="info-label">æ´»åŠ¨æ—¶é—´</view>
              <view class="info-value">{{activity.formattedTime}}</view>
            </view>
          </view>
          
          <view class="info-item">
            <view class="info-icon">ğŸ“</view>
            <view class="info-content">
              <view class="info-label">æ´»åŠ¨åœ°ç‚¹</view>
              <view class="info-value">{{activity.activityLocation}}</view>
            </view>
          </view>
          
          <view class="info-item" wx:if="{{activity.formattedReserveTime}}">
            <view class="info-icon">ğŸ“…</view>
            <view class="info-content">
              <view class="info-label">é¢„çº¦æ—¶é—´</view>
              <view class="info-value">{{activity.formattedReserveTime}}</view>
            </view>
          </view>
          
          <view class="info-item">
            <view class="info-icon">ğŸ“</view>
            <view class="info-content">
              <view class="info-label">ç­¾åˆ°è¦æ±‚</view>
              <view class="info-value">
                <text wx:if="{{activity.needFace}}">äººè„¸è¯†åˆ«</text>
                <text wx:if="{{activity.needFace && activity.needPhoto}}"> | </text>
                <text wx:if="{{activity.needPhoto}}">ç…§ç‰‡ç­¾åˆ°</text>
                <text wx:if="{{!activity.needFace && !activity.needPhoto}}">æ— ç‰¹æ®Šè¦æ±‚</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å‚ä¸è€…åˆ—è¡¨ -->
      <view class="participant-card">
        <view class="section-title">
          å‚ä¸è€… <text class="participant-count">({{participants.length}})</text>
          <view class="view-all" bindtap="viewAllParticipants" wx:if="{{participants.length > 0}}">æŸ¥çœ‹å…¨éƒ¨</view>
        </view>
        <view class="participant-list">
          <block wx:if="{{participants.length > 0}}">
            <view class="participant-item" wx:for="{{participants}}" wx:key="id" wx:if="{{index < 10}}">
              <image class="participant-avatar" src="{{item.avatar}}" mode="aspectFill" bindtap="previewAvatar" data-url="{{item.avatar}}"></image>
              <view class="participant-name">{{item.name}}</view>
              <view class="participant-tag" wx:if="{{item.isCreator}}">åˆ›å»ºè€…</view>
            </view>
          </block>
          <view class="no-data" wx:else>
            æš‚æ— å‚ä¸è€…
          </view>
        </view>
      </view>
      
      <!-- åº•éƒ¨æ“ä½œæ  -->
      <view class="bottom-bar">
        <block wx:if="{{activity.creatorId === app.globalData.userInfo.id}}">
          <button class="btn-edit" bindtap="editActivity" wx:if="{{!readonly}}">ç¼–è¾‘æ´»åŠ¨</button>
        </block>
        <block wx:else>
          <button class="btn-join {{isParticipant ? 'btn-disabled' : ''}}" bindtap="openJoinModal" disabled="{{isParticipant}}">
            {{isParticipant ? 'å·²åŠ å…¥' : 'åŠ å…¥æ´»åŠ¨'}}
          </button>
        </block>
        <button class="btn-share" open-type="share">åˆ†äº«æ´»åŠ¨</button>
      </view>
    </block>
  </block>
  
  <block wx:else>
    <view class="error-container">
      <view class="error-icon">âŒ</view>
      <view class="error-text">æ´»åŠ¨åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</view>
    </view>
  </block>
  
  <!-- åŠ å…¥æ´»åŠ¨å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showJoinModal}}" bindtap="closeJoinModal"></view>
  <view class="modal" wx:if="{{showJoinModal}}">
    <view class="modal-header">
      <view class="modal-title">åŠ å…¥æ´»åŠ¨</view>
      <view class="modal-close" bindtap="closeJoinModal">Ã—</view>
    </view>
    
    <view class="modal-body">
      <view class="form-group">
        <view class="form-label">ç­¾åˆ°ä½ç½® <text class="required">*</text></view>
        <view class="location-picker" bindtap="chooseCheckInLocation">
          <text>{{joinParams.checkInLocation ? (joinParams.checkInLocation.name || joinParams.checkInLocation.address) : 'è¯·é€‰æ‹©ç­¾åˆ°ä½ç½®'}}</text>
          <text class="icon-location">ğŸ“</text>
        </view>
        <view class="form-hint">ç­¾åˆ°æ—¶éœ€è¦åœ¨æ­¤ä½ç½®é™„è¿‘æ‰èƒ½æˆåŠŸç­¾åˆ°</view>
      </view>
      
      <view class="form-group">
        <view class="form-label">ç­¾åˆ°èŒƒå›´</view>
        <view class="range-slider">
          <slider min="50" max="2000" step="50" value="{{joinParams.checkInRange}}" show-value bindchange="changeCheckInRange" activeColor="#3b7ff3" />
          <view class="range-display">{{joinParams.checkInRange}}ç±³</view>
        </view>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn-cancel" bindtap="closeJoinModal">å–æ¶ˆ</button>
      <button class="btn-confirm" bindtap="joinActivity">ç¡®è®¤åŠ å…¥</button>
    </view>
  </view>
</view> 